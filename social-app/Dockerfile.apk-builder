# =============================================================================
# è¶£ç©ç¤¾åŒº App - Docker APK æ„å»ºé•œåƒ
# APK Builder - Android APK æ‰“åŒ…ç¯å¢ƒ
# =============================================================================
# ä½¿ç”¨æ–¹æ³•:
#   docker build -f Dockerfile.apk-builder -t social-app-apk-builder .
#   docker run -v $(pwd)/output:/app/output social-app-apk-builder [debug|release]
# =============================================================================

FROM ubuntu:22.04

# è®¾ç½® Shell é€‰é¡¹ä»¥ä¾¿æ›´å¥½åœ°å¤„ç†ç®¡é“é”™è¯¯
SHELL ["/bin/bash", "-o", "pipefail", "-c"]

# é¿å…äº¤äº’å¼æç¤º
ENV DEBIAN_FRONTEND=noninteractive

# è®¾ç½® Android SDK ç¯å¢ƒå˜é‡
ENV ANDROID_HOME=/opt/android-sdk
ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV PATH="${PATH}:${ANDROID_HOME}/cmdline-tools/latest/bin:${ANDROID_HOME}/platform-tools:${ANDROID_HOME}/build-tools/34.0.0"

# è®¾ç½® Java ç¯å¢ƒå˜é‡
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64

# è®¾ç½®æ—¶åŒº
ENV TZ=Asia/Shanghai
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# =============================================================================
# å®‰è£…åŸºç¡€ä¾èµ–
# =============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    # åŸºç¡€å·¥å…·
    curl \
    wget \
    unzip \
    git \
    ca-certificates \
    gnupg \
    # Java JDK 17
    openjdk-17-jdk \
    # æ„å»ºå·¥å…·
    build-essential \
    # 32ä½åº“æ”¯æŒ (Android SDKéœ€è¦)
    lib32stdc++6 \
    lib32z1 \
    # æ¸…ç†ç¼“å­˜
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# å®‰è£… Node.js 18.x LTS
# =============================================================================
RUN curl -fsSL https://deb.nodesource.com/setup_18.x | bash - \
    && apt-get install -y --no-install-recommends nodejs \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* \
    && npm install -g npm@latest

# =============================================================================
# å®‰è£… Android SDK å‘½ä»¤è¡Œå·¥å…·
# =============================================================================
# ä½¿ç”¨æœ€æ–°ç¨³å®šç‰ˆæœ¬çš„å‘½ä»¤è¡Œå·¥å…·
ARG CMDLINE_TOOLS_VERSION=11076708
ARG BUILD_TOOLS_VERSION=34.0.0
ARG PLATFORM_VERSION=android-34

WORKDIR ${ANDROID_HOME}/cmdline-tools
RUN wget -q https://dl.google.com/android/repository/commandlinetools-linux-${CMDLINE_TOOLS_VERSION}_latest.zip -O cmdline-tools.zip \
    && unzip -q cmdline-tools.zip \
    && rm cmdline-tools.zip \
    && mv cmdline-tools latest

# æ¥å— Android SDK è®¸å¯åè®®
# æ³¨æ„: æŸäº›è®¸å¯å¯èƒ½è¿”å›éé›¶é€€å‡ºç ï¼Œè¿™æ˜¯æ­£å¸¸çš„
RUN yes | ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 | tee /tmp/license-output.log || true \
    && echo "SDK è®¸å¯åè®®å¤„ç†å®Œæˆ (è¯¦è§ /tmp/license-output.log)"

# å®‰è£… Android SDK ç»„ä»¶
RUN ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager --update \
    && ${ANDROID_HOME}/cmdline-tools/latest/bin/sdkmanager \
        "platform-tools" \
        "build-tools;${BUILD_TOOLS_VERSION}" \
        "platforms;${PLATFORM_VERSION}"

# =============================================================================
# è®¾ç½®å·¥ä½œç›®å½•
# =============================================================================
WORKDIR /app

# å¤åˆ¶ package æ–‡ä»¶å¹¶å®‰è£…ä¾èµ–
# æ³¨æ„: ä½¿ç”¨ npm install ä»¥å…è®¸æ·»åŠ  Capacitor ä¾èµ–
COPY package*.json ./
RUN npm install --silent \
    && npm install @capacitor/core @capacitor/cli @capacitor/android --save

# å¤åˆ¶æºä»£ç 
COPY . .

# åˆ›å»ºè¾“å‡ºç›®å½•
RUN mkdir -p /app/output

# =============================================================================
# æ„å»ºå…¥å£è„šæœ¬
# =============================================================================
COPY <<'EOF' /app/docker-build-apk.sh
#!/bin/bash
# =============================================================================
# Docker å®¹å™¨å†… APK æ„å»ºè„šæœ¬
# =============================================================================

MODE=${1:-debug}

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘      ğŸ³ Docker APK æ„å»ºç¯å¢ƒ                                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“¦ æ„å»ºæ¨¡å¼: $MODE"
echo "ğŸ“ Android SDK: $ANDROID_HOME"
echo "â˜• Java: $(java --version 2>&1 | head -1)"
echo "ğŸ“— Node.js: $(node --version)"
echo ""

# æ£€æŸ¥æ˜¯å¦éœ€è¦åˆå§‹åŒ– Capacitor
if [ ! -f "capacitor.config.ts" ] && [ ! -f "capacitor.config.json" ]; then
    echo "ğŸ“ åˆå§‹åŒ– Capacitor..."
    npx cap init "è¶£ç©ç¤¾åŒº" "com.quwan.social" --web-dir=build
fi

# æ£€æŸ¥æ˜¯å¦æ·»åŠ äº† Android å¹³å°
if [ ! -d "android" ]; then
    echo "ğŸ“² æ·»åŠ  Android å¹³å°..."
    npx cap add android
    if [ $? -ne 0 ]; then
        echo "âŒ æ·»åŠ  Android å¹³å°å¤±è´¥ï¼"
        exit 1
    fi
fi

# æ„å»º Web åº”ç”¨
echo ""
echo "ğŸ”¨ æ„å»º Web åº”ç”¨..."
npm run build

if [ $? -ne 0 ]; then
    echo "âŒ Web æ„å»ºå¤±è´¥ï¼"
    exit 1
fi

# åŒæ­¥ Capacitor
echo ""
echo "ğŸ“² åŒæ­¥åˆ° Android..."
npx cap sync android

if [ $? -ne 0 ]; then
    echo "âŒ Capacitor åŒæ­¥å¤±è´¥ï¼"
    exit 1
fi

# æ„å»º APK
echo ""
echo "ğŸ“¦ æ„å»º APK..."
cd android

# æ¸…ç†ä¹‹å‰çš„æ„å»º (å¿½ç•¥é”™è¯¯ï¼Œå› ä¸ºå¯èƒ½æ˜¯é¦–æ¬¡æ„å»º)
./gradlew clean 2>&1 || true

if [ "$MODE" = "release" ]; then
    echo "   æ¨¡å¼: Release (ç­¾åç‰ˆæœ¬)"
    ./gradlew --no-daemon assembleRelease
    APK_PATH="app/build/outputs/apk/release/app-release.apk"
    APK_UNSIGNED_PATH="app/build/outputs/apk/release/app-release-unsigned.apk"
else
    echo "   æ¨¡å¼: Debug (è°ƒè¯•ç‰ˆæœ¬)"
    ./gradlew --no-daemon assembleDebug
    APK_PATH="app/build/outputs/apk/debug/app-debug.apk"
fi

BUILD_RESULT=$?
cd ..

if [ $BUILD_RESULT -eq 0 ]; then
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âœ… APK æ‰“åŒ…æˆåŠŸï¼"
    echo ""
    
    # å¤åˆ¶ APK åˆ°è¾“å‡ºç›®å½•
    FULL_APK_PATH="android/$APK_PATH"
    if [ -f "$FULL_APK_PATH" ]; then
        cp "$FULL_APK_PATH" /app/output/
        SIZE=$(du -h "$FULL_APK_PATH" | cut -f1)
        echo "ğŸ“ APK å·²å¤åˆ¶åˆ°: /app/output/$(basename $APK_PATH)"
        echo "ğŸ“Š APK å¤§å°: $SIZE"
    elif [ -f "android/$APK_UNSIGNED_PATH" ]; then
        cp "android/$APK_UNSIGNED_PATH" /app/output/
        SIZE=$(du -h "android/$APK_UNSIGNED_PATH" | cut -f1)
        echo "ğŸ“ APK å·²å¤åˆ¶åˆ°: /app/output/$(basename $APK_UNSIGNED_PATH)"
        echo "ğŸ“Š APK å¤§å°: $SIZE"
        echo ""
        echo "âš ï¸  æ³¨æ„: è¿™æ˜¯æœªç­¾åçš„ APKï¼Œéœ€è¦ç­¾ååæ‰èƒ½å‘å¸ƒ"
    fi
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âŒ APK æ‰“åŒ…å¤±è´¥ï¼"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 1
fi
EOF

RUN chmod +x /app/docker-build-apk.sh

# =============================================================================
# é»˜è®¤å…¥å£ç‚¹
# =============================================================================
ENTRYPOINT ["/app/docker-build-apk.sh"]
CMD ["debug"]
