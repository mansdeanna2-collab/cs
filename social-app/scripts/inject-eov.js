#!/usr/bin/env node
/**
 * EOVé…ç½®æ³¨å…¥è„šæœ¬ (EOV Config Injection Script)
 * =============================================
 * è¯»å–é¡¹ç›®æ ¹ç›®å½•çš„ .eov æ–‡ä»¶ï¼Œå¹¶ç”Ÿæˆç¯å¢ƒå˜é‡é…ç½®
 * Reads .eov file from project root and generates environment variable configuration
 * 
 * ä½¿ç”¨æ–¹æ³• (Usage):
 *   node scripts/inject-eov.js              # ç”Ÿæˆ .env.local æ–‡ä»¶
 *   node scripts/inject-eov.js --print      # æ‰“å°é…ç½®ä¿¡æ¯
 * 
 * æ­¤è„šæœ¬åœ¨æ„å»ºå‰è¿è¡Œï¼Œç¡®ä¿ .eov ä¸­çš„é…ç½®è¢«æ­£ç¡®åº”ç”¨åˆ°æ„å»ºä¸­
 * This script runs before build to ensure .eov config is properly applied
 */

const fs = require('fs');
const path = require('path');

// è·å–é¡¹ç›®æ ¹ç›®å½• (Get project root directory)
const projectRoot = path.resolve(__dirname, '..');
const repoRoot = path.resolve(projectRoot, '..');

// .eov æ–‡ä»¶æœç´¢è·¯å¾„åˆ—è¡¨ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åº (EOV file search paths in priority order)
// 1. ä»“åº“æ ¹ç›®å½• (repo root) - æ ‡å‡†ä½ç½®
// 2. é¡¹ç›®æ ¹ç›®å½• (project root) - Dockerå®¹å™¨å†…çš„å¤‡é€‰ä½ç½®
const eovSearchPaths = [
  path.join(repoRoot, '.eov'),     // æ ‡å‡†ä½ç½®: ../.eov (ä»“åº“æ ¹ç›®å½•)
  path.join(projectRoot, '.eov'),  // å¤‡é€‰ä½ç½®: ./.eov (é¡¹ç›®æ ¹ç›®å½•ï¼Œç”¨äºDocker)
];

// æŸ¥æ‰¾å¯ç”¨çš„ .eov æ–‡ä»¶ (Find available .eov file)
function findEovFile() {
  for (const filePath of eovSearchPaths) {
    if (fs.existsSync(filePath)) {
      return filePath;
    }
  }
  return null;
}

const envLocalPath = path.join(projectRoot, '.env.local');

/**
 * è§£æEOVæ–‡ä»¶å†…å®¹ (Parse EOV file content)
 * @param {string} content - EOVæ–‡ä»¶å†…å®¹ (EOV file content)
 * @returns {Object} è§£æåçš„é…ç½®å¯¹è±¡ (Parsed config object)
 */
function parseEOV(content) {
  const config = {};
  const lines = content.split('\n');

  for (const line of lines) {
    const trimmedLine = line.trim();
    
    // è·³è¿‡æ³¨é‡Šè¡Œå’Œç©ºè¡Œ (Skip comment lines and empty lines)
    if (trimmedLine.startsWith('#') || trimmedLine === '') {
      continue;
    }

    // è§£æ KEY=VALUE æ ¼å¼ (Parse KEY=VALUE format)
    const equalIndex = trimmedLine.indexOf('=');
    if (equalIndex > 0) {
      const key = trimmedLine.substring(0, equalIndex).trim();
      let value = trimmedLine.substring(equalIndex + 1).trim();
      
      // ç§»é™¤å¼•å· (Remove surrounding quotes)
      if ((value.startsWith('"') && value.endsWith('"')) ||
          (value.startsWith("'") && value.endsWith("'"))) {
        value = value.slice(1, -1);
      }
      
      config[key] = value;
    }
  }

  return config;
}

/**
 * å°†EOVé…ç½®è½¬æ¢ä¸ºReactç¯å¢ƒå˜é‡æ ¼å¼ (Convert EOV config to React env var format)
 * @param {Object} eovConfig - EOVé…ç½®å¯¹è±¡ (EOV config object)
 * @returns {Object} Reactç¯å¢ƒå˜é‡å¯¹è±¡ (React env var object)
 */
function convertToReactEnv(eovConfig) {
  const reactEnv = {};

  // æ˜ å°„EOVé…ç½®åˆ°Reactç¯å¢ƒå˜é‡ (Map EOV config to React env vars)
  if (eovConfig.API_BASE_URL) {
    reactEnv.REACT_APP_API_URL = eovConfig.API_BASE_URL;
  }
  if (eovConfig.API_VERSION) {
    reactEnv.REACT_APP_API_VERSION = eovConfig.API_VERSION;
  }
  if (eovConfig.API_TIMEOUT) {
    reactEnv.REACT_APP_API_TIMEOUT = eovConfig.API_TIMEOUT;
  }

  return reactEnv;
}

/**
 * ç”Ÿæˆ.env.localæ–‡ä»¶å†…å®¹ (Generate .env.local file content)
 * @param {Object} reactEnv - Reactç¯å¢ƒå˜é‡å¯¹è±¡ (React env var object)
 * @returns {string} .env.localæ–‡ä»¶å†…å®¹ (.env.local file content)
 */
function generateEnvContent(reactEnv) {
  let content = `# ç”± inject-eov.js è‡ªåŠ¨ç”Ÿæˆ (Auto-generated by inject-eov.js)
# è¯·å‹¿æ‰‹åŠ¨ç¼–è¾‘æ­¤æ–‡ä»¶ï¼Œä¿®æ”¹ .eov æ–‡ä»¶åé‡æ–°è¿è¡Œè„šæœ¬
# Do not edit this file manually, modify .eov file and re-run script
# ç”Ÿæˆæ—¶é—´ (Generated at): ${new Date().toISOString()}

`;

  for (const [key, value] of Object.entries(reactEnv)) {
    content += `${key}=${value}\n`;
  }

  return content;
}

/**
 * ä¸»å‡½æ•° (Main function)
 */
function main() {
  const args = process.argv.slice(2);
  const printOnly = args.includes('--print');

  console.log('ğŸ“‹ EOVé…ç½®æ³¨å…¥å·¥å…· (EOV Config Injection Tool)');
  console.log('='.repeat(50));

  // æŸ¥æ‰¾.eovæ–‡ä»¶ (Find .eov file)
  const eovFilePath = findEovFile();
  
  // æ£€æŸ¥.eovæ–‡ä»¶æ˜¯å¦å­˜åœ¨ (Check if .eov file exists)
  if (!eovFilePath) {
    console.error('âŒ é”™è¯¯: æœªæ‰¾åˆ° .eov æ–‡ä»¶');
    console.error('   å·²æœç´¢ä»¥ä¸‹ä½ç½®:');
    for (const searchPath of eovSearchPaths) {
      console.error(`   - ${searchPath}`);
    }
    console.error('   è¯·åœ¨é¡¹ç›®æ ¹ç›®å½•æˆ–ä»“åº“æ ¹ç›®å½•åˆ›å»º .eov æ–‡ä»¶');
    process.exit(1);
  }

  // è¯»å–å¹¶è§£æ.eovæ–‡ä»¶ (Read and parse .eov file)
  console.log(`ğŸ“‚ è¯»å–é…ç½®æ–‡ä»¶: ${eovFilePath}`);
  const eovContent = fs.readFileSync(eovFilePath, 'utf-8');
  const eovConfig = parseEOV(eovContent);

  console.log('\nğŸ“Š è§£æåˆ°çš„EOVé…ç½®:');
  for (const [key, value] of Object.entries(eovConfig)) {
    console.log(`   ${key} = ${value}`);
  }

  // è½¬æ¢ä¸ºReactç¯å¢ƒå˜é‡ (Convert to React env vars)
  const reactEnv = convertToReactEnv(eovConfig);

  console.log('\nğŸ”„ è½¬æ¢åçš„Reactç¯å¢ƒå˜é‡:');
  for (const [key, value] of Object.entries(reactEnv)) {
    console.log(`   ${key} = ${value}`);
  }

  if (printOnly) {
    console.log('\nâœ… æ‰“å°æ¨¡å¼å®Œæˆ');
    return;
  }

  // ç”Ÿæˆ.env.localæ–‡ä»¶ (Generate .env.local file)
  const envContent = generateEnvContent(reactEnv);
  fs.writeFileSync(envLocalPath, envContent);

  console.log(`\nâœ… å·²ç”Ÿæˆé…ç½®æ–‡ä»¶: ${envLocalPath}`);
  console.log('   è¯·è¿è¡Œ npm run build æˆ– npm start åº”ç”¨æ–°é…ç½®');
  console.log('='.repeat(50));
}

// è¿è¡Œä¸»å‡½æ•° (Run main function)
main();
